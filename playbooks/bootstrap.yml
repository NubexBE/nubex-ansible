- hosts: localhost
  become: true
  vars_files:
    - vars/users.yml

  roles:
    - role: geerlingguy.docker

  tasks:
    - import_tasks: tasks/create_user_with_gh_key.yml
    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: true
    - name: Ensure '/srv' exists and has docker group-write, setuid, setgid
      file:
        path: '/srv'
        state: directory
        owner: root
        group: docker
        recurse: true
        mode: g=rwx
    # - name: Clone repo into target directory
    #   git:
    #     repo: git@github.com:edencehealth/drive_pilot_deployment.git
    #     accept_newhostkey: true
    #     dest: /srv/omop
    #     key_file: /home/ubuntu/.ssh/id_rsa_git # Adjust path as necessary, use full path
    - name: Install packages
      package:
        name:
          - htop
          - mc
          - tmux
    - name: Add users
      user:
        name: "{{ item.name }}"
        uid: "{{ item.uid }}"
        groups: "{{ item.groups }}"
        shell: /bin/bash
        create_home: yes
        state: present
      loop: "{{ users_to_add }}"
    
